import { select, call, put, apply } from 'redux-saga/effects';

import { NodeError } from "error";
import { errorThrown } from "error/actions";
import { getCurrentSaga } from "naming/sagas";
import { ownerSet, ownerVerified } from "mainmenu/owner/actions";

export function* ownerLoadSaga() {
    const {rootApi, rootPage} = yield select(state => ({
        rootApi: state.root.api,
        rootPage:  state.root.page}));
    try {
        let response;
        try {
            response = yield call(fetch, rootApi + "/profile");
        } catch (e) {
            throw new NodeError(e);
        }
        if (!response.ok) {
            throw new NodeError("Server returned error status");
        }
        const data = yield apply(response, response.json);
        yield put(ownerSet(data.registeredName, data.registeredNameGeneration));
        if (data.registeredName == null) {
            return;
        }
        const ndata = yield call(getCurrentSaga, data.registeredName, data.registeredNameGeneration);
        const prefix = ndata.nodeUri + (ndata.nodeUri.endsWith("/") ? "" : "/");
        const correct = rootPage.startsWith(prefix) && rootApi.startsWith(prefix);
        yield put(ownerVerified(data.registeredName, data.registeredNameGeneration, ndata.latest, correct));
    } catch (e) {
        yield put(errorThrown(e));
    }
}
