import { select, call, put, apply } from 'redux-saga/effects';

import { ownerSet, ownerVerified } from "mainmenu/owner/actions";
import { getCurrentSaga } from "naming/sagas";

export function* ownerLoadSaga() {
    const {rootApi, rootPage} = yield select(state => ({
        rootApi: state.root.api,
        rootPage:  state.root.page}));
    const response = yield call(fetch, rootApi + "/profile");
    const data = yield apply(response, response.json);
    yield put(ownerSet(data.registeredName, data.registeredNameGeneration));
    if (data.registeredName == null) {
        return;
    }
    const ndata = yield* getCurrentSaga(data.registeredName, data.registeredNameGeneration);
    const prefix = ndata.nodeUri + (ndata.nodeUri.endsWith("/") ? "" : "/");
    const correct = rootPage.startsWith(prefix) && rootApi.startsWith(prefix);
    yield put(ownerVerified(data.registeredName, data.registeredNameGeneration, ndata.latest, correct));
}
