import React from 'react';
import PropType from 'prop-types';
import { connect } from 'react-redux';
import { Form, withFormik } from 'formik';
import * as yup from 'yup';

import { Button, ComboboxField, InputField, Loading } from "ui/control";
import { profileEditCancel, profileUpdate } from "state/profile/actions";
import "./ProfileEditor.css";

const ProfileLine = ({title, children}) => (
    <>
        <dt className="col-sm-2">{title}</dt>
        <dd className="col-sm-10">{children}</dd>
    </>
);

ProfileLine.propTypes = {
    title: PropType.string
};

class ProfileEditor extends React.PureComponent {

    static propTypes = {
        loading: PropType.bool,
        loaded: PropType.bool,
        updating: PropType.bool,
        fullName: PropType.string,
        gender: PropType.string,
        email: PropType.string
    };

    componentDidUpdate(prevProps, prevState, snapshot) {
        if (this.props.loaded && !prevProps.loaded) {
            this.props.resetForm();
        }
    }

    render() {
        const {loading, updating, profileEditCancel} = this.props;

        return (
            <>
                <h2>
                    Edit Profile <Loading active={loading} />
                </h2>
                <Form>
                    <dl className="row">
                        <ProfileLine title="Full name">
                            <InputField name="fullName" anyValue autoFocus />
                        </ProfileLine>
                        <ProfileLine title="Gender">
                            <ComboboxField name="gender" data={["Male", "Female"]} />
                        </ProfileLine>
                        <ProfileLine title="E-Mail">
                            <InputField name="email" />
                        </ProfileLine>
                    </dl>
                    <div className="editor-footer">
                        <Loading active={updating} />
                        <Button variant="secondary" onClick={profileEditCancel} disabled={updating}>Cancel</Button>
                        <Button variant="primary" type="submit" disabled={updating}>Update</Button>
                    </div>
                </Form>
            </>
        );
    }

}

const profileEditorLogic = {

    mapPropsToValues(props) {
        return {
            fullName: props.fullName || "",
            gender: props.gender || "",
            email: props.email || ""
        }
    },

    validationSchema: yup.object().shape({
        fullName: yup.string().trim().max(255, "Too long"),
        gender: yup.string().trim().max(31, "Too long"),
        email: yup.string().trim().max(63, "Too long").email("Must be a valid e-mail")
    }),

    handleSubmit(values, formik) {
        formik.props.profileUpdate({
            fullName: values.fullName.trim(),
            gender: values.gender.trim(),
            email: values.email.trim()
        });
        formik.setSubmitting(false);
    }

};

export default connect(
    state => ({
        loading: state.profile.loading,
        loaded: state.profile.loaded,
        updating: state.profile.updating,
        fullName: state.profile.fullName,
        gender: state.profile.gender,
        email: state.profile.email
    }),
    {profileEditCancel, profileUpdate}
)(withFormik(profileEditorLogic)(ProfileEditor));
