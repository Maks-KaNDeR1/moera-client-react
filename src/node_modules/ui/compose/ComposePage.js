import React from 'react';
import { connect } from 'react-redux';
import { connect as connectFormik, Form, withFormik } from 'formik';
import * as yup from 'yup';
import moment from 'moment';

import { Page } from "ui/page/Page";
import { Button, DateTimeField, Loading, SelectField, TextField } from "ui/control";
import ComposeIconButton from "ui/compose/ComposeIconButton";
import { composePost } from "state/compose/actions";

const PublishAtImpl = ({formik}) => (
    <div className="d-flex">
        <ComposeIconButton icon="clock" name="publishAtCustomized" />
        {formik.values.publishAtCustomized &&
            <DateTimeField title="Publish at" name="publishAt" horizontal={true} groupClassName="col-12 ml-0 pl-2"
                           col="col-md-3" />}
    </div>
);

const PublishAt = connectFormik(PublishAtImpl);

const SubmitButtonImpl = ({disabled, formik}) => {
    disabled = disabled || formik.values["body"].trim().length === 0;
    return <Button variant="primary" block type="submit" disabled={disabled}>Post</Button>
};

const SubmitButton = connectFormik(SubmitButtonImpl);

const ComposePage = ({loadingFeatures, sourceFormats, beingPosted}) => (
    <Page>
        <h2>New Post <Loading active={loadingFeatures} /></h2>
        <br />
        <Form>
            <SelectField name="bodyFormat" col="col-md-2 pl-0" size="sm" choices={sourceFormats} anyValue />
            <TextField name="body" anyValue autoFocus />
            <PublishAt />
            <SubmitButton disabled={beingPosted} />
            <Loading active={beingPosted} />
        </Form>
    </Page>
);

const composePageLogic = {

    mapPropsToValues(props) {
        return {
            body: props.body || "",
            bodyFormat: props.bodyFormat || "markdown",
            publishAtCustomized: props.publishAtCustomized || false,
            publishAt: props.publishAt || new Date()
        };
    },

    validationSchema: yup.object().shape({
        body: yup.string().trim().required("Must not be empty")
    }),

    handleSubmit(values, formik) {
        formik.props.composePost({
            bodySrc: values.body.trim(),
            bodySrcFormat: values.bodyFormat.trim(),
            publishAt: values.publishAtCustomized ? moment(values.publishAt).unix() : null
        });
        formik.setSubmitting(false);
    }

};

export default connect(
    state => ({
        loadingFeatures: state.compose.loadingFeatures,
        sourceFormats: state.compose.sourceFormats,
        beingPosted: state.compose.beingPosted
    }),
    {composePost}
)(withFormik(composePageLogic)(ComposePage));
