import React from 'react';
import { connect } from 'react-redux';
import moment from 'moment';

import { goToPosting } from "state/navigation/actions";
import { isPermitted } from "state/node/selectors";
import PostingMenu from "ui/posting/PostingMenu";
import PostingUpdated from "ui/posting/PostingUpdated";
import "ui/posting/Posting.css";

const Content = ({posting, href, onClick}) => {
    if (posting.bodyPreviewHtml) {
        return (
            <div className="content">
                <div dangerouslySetInnerHTML={{__html: posting.bodyPreviewHtml}} />
                <a href={href} onClick={onClick}>Continue Reading &rarr;</a>
            </div>
        );
    } else {
        return (
            <div className="content" dangerouslySetInnerHTML={{__html: posting.bodyHtml}} />
        );
    }
};

class TimelinePosting extends React.PureComponent {

    constructor(props) {
        super(props);

        this.onClick = this.onClick.bind(this);
    }

    onClick(e) {
        this.props.goToPosting(this.props.posting.id);
        e.preventDefault();
    }

    render() {
        const {posting, isPermitted, rootLocation} = this.props;

        const href = `${rootLocation}/post/${posting.id}`;
        return (
            <div className="posting" data-moment={posting.moment}>
                <PostingMenu posting={posting} isPermitted={isPermitted} />
                <a className="date" href={href} onClick={this.onClick}>
                    {moment.unix(posting.publishedAt).format("DD-MM-YYYY HH:mm")}
                </a>
                <PostingUpdated posting={posting} />
                <Content posting={posting} href={href} onClick={this.onClick}/>
            </div>
        );
    }

}

export default connect(
    state => ({
        rootLocation: state.node.root.location,
        isPermitted: (operation, posting) => isPermitted(operation, posting, state)
    }),
    { goToPosting }
)(TimelinePosting);
