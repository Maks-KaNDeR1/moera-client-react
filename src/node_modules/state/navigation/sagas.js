import { put, select } from 'redux-saga/effects';
import * as URI from 'uri-js';

import { locationSet } from "state/navigation/actions";
import LocationInfo from "state/navigation/LocationInfo";
import {transform as locationTransform, build as locationBuild} from "state/location";

export function* initFromLocationSaga(action) {
    let {path, query} = action.payload;
    path = path.startsWith("/moera") ? path.substring(6) : path;
    const actions = locationTransform(new LocationInfo(), LocationInfo.fromUrl(path, query));
    for (let a of actions) {
        yield put(a);
    }
}

export function* updateLocationSaga() {
    const info = yield select(locationBuild, new LocationInfo());
    yield put(locationSet(info.toUrl(), info.title));
}

export function* goToLocationSaga(action) {
    const current = URI.parse(yield select(state => state.navigation.location));
    let {path, query} = action.payload;
    path = path.startsWith("/moera") ? path.substring(6) : path;
    const actions = locationTransform(
        LocationInfo.fromUrl(current.path, current.query), LocationInfo.fromUrl(path, query));
    for (let a of actions) {
        yield put(a);
    }
}
