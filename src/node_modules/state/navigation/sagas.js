import { call, put, select } from 'redux-saga/effects';
import * as URI from 'uri-js';

import { locationLock, locationSet, locationUnlock, UPDATE_LOCATION } from "state/navigation/actions";
import LocationInfo from "state/navigation/LocationInfo";
import { build as locationBuild, transform as locationTransform } from "state/location";

function* transformation(srcPath, srcQuery, dstPath, dstQuery) {
    const srcInfo = srcPath != null ? LocationInfo.fromUrl(srcPath, srcQuery) : new LocationInfo();
    dstPath = dstPath.startsWith("/moera") ? dstPath.substring(6) : dstPath;
    const dstInfo = LocationInfo.fromUrl(dstPath, dstQuery);
    const actions = locationTransform(srcInfo, dstInfo);
    yield put(locationLock());
    for (let a of actions) {
        yield put(a);
    }
    yield call(updateLocationSaga);
    yield put(locationUnlock());
}

export function* initFromLocationSaga(action) {
    let {path, query} = action.payload;
    yield call(transformation, null, null, path, query);
}

export function* goToLocationSaga(action) {
    const current = URI.parse(yield select(state => state.navigation.location));
    let {path, query} = action.payload;
    yield call(transformation, current.path || "", current.query || "", path, query);
}

export function* updateLocationSaga(action) {
    const info = yield select(locationBuild, new LocationInfo());
    yield put(locationSet(info.toUrl(), info.title, action == null || action.type === UPDATE_LOCATION));
}
