import { ERROR_THROWN } from "state/error/actions";
import { OWNER_LOAD } from "state/owner/actions";
import { CONNECT_TO_HOME, CONNECTED_TO_HOME } from "state/home/actions";
import { PROFILE_LOAD, PROFILE_UPDATE, PROFILE_UPDATE_SUCCEEDED } from "state/profile/actions";

import { applyMiddleware, combineReducers, createStore } from 'redux';
import error from "state/error/reducer";
import naming from "state/naming/reducer";
import node from "state/node/reducer";
import home from "state/home/reducer";
import tokens from "state/tokens/reducer";
import connectDialog from "state/connectdialog/reducer";
import owner from "state/owner/reducer";
import profile from "state/profile/reducer";
import messageBox from "state/messagebox/reducer";

import createSagaMiddleware from 'redux-saga';
import { takeEvery, takeLatest } from 'redux-saga/effects';
import { errorSaga } from "state/error/sagas";
import { ownerLoadSaga } from "state/owner/sagas";
import { connectToHomeSaga, verifyHomeOwnerSaga } from "state/home/connect";
import { profileLoadSaga, profileUpdateSaga } from "state/profile/sagas";

import { collectTriggers, triggersSaga } from "state/trigger";
import profileTriggers from "state/profile/triggers";

const triggers = collectTriggers(profileTriggers);

function* combinedSaga() {
    yield takeLatest(ERROR_THROWN, errorSaga);
    yield takeLatest(OWNER_LOAD, ownerLoadSaga);
    yield takeLatest(CONNECT_TO_HOME, connectToHomeSaga);
    yield takeLatest(CONNECTED_TO_HOME, verifyHomeOwnerSaga);
    yield takeLatest(PROFILE_LOAD, profileLoadSaga);
    yield takeLatest(PROFILE_UPDATE, profileUpdateSaga);

    yield takeEvery([PROFILE_UPDATE_SUCCEEDED], triggersSaga, triggers);
}

const sagaMiddleware = createSagaMiddleware();
export default createStore(
    combineReducers({ error, naming, node, home, tokens, connectDialog, owner, profile, messageBox }),
    applyMiddleware(sagaMiddleware)
);

sagaMiddleware.run(combinedSaga);
