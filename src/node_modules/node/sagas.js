import schm from 'schm';
import { select, call, apply } from 'redux-saga/effects';

import { NodeError } from "error";
import * as NodeApi from "node/api";

export function* callNodeGeneric(location, schema, rootApiSelector, exceptionClass) {
    const rootApi = yield select(rootApiSelector);
    let response;
    try {
        response = yield call(fetch, rootApi + location);
    } catch (e) {
        throw new exceptionClass(e);
    }
    if (!response.ok) {
        throw new exceptionClass("Server returned error status");
    }
    const data = yield apply(response, response.json);
    if (!schema) {
        return data;
    }
    try {
        return yield call(schm.validate, data, schema);
    } catch (errors) {
        const desc = errors.map(({message}) => message).join(", ");
        throw new exceptionClass(location + " returned incorrect response: " + desc);
    }
}

function* callNode(location, schema = null) {
    return yield call(callNodeGeneric, location, schema, state => state.node.root.api, NodeError);
}

export function* getWhoAmI() {
    return yield call(callNode, "/whoami", NodeApi.WhoAmI);
}

export function* getProfile() {
    return yield call(callNode, "/profile", NodeApi.ProfileInfo);
}
