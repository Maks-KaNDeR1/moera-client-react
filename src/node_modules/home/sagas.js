import { apply, call, put } from 'redux-saga/effects';

import { normalizeUrl } from "util/util";
import { connectedToHome, connectionToHomeFailed, connectionToHomeLoginFailed } from "home/actions";

export function* connectToHome(action) {
    const {location, login, password} = action.payload;
    const url = normalizeUrl(location) + "/moera/api/tokens";
    let response;
    try {
        response = yield call(fetch, url, {
            method: "POST",
            headers: {
                "Accept": "application/json",
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                login,
                password
            })
        });
    } catch (e) {
        yield put(connectionToHomeFailed(e.message));
        return;
    }
    const data = yield apply(response, response.json);
    if (!response.ok) {
        if (data && data.errorCode === "credentials.login-incorrect") {
            yield put(connectionToHomeLoginFailed());
        } else {
            yield put(connectionToHomeFailed(response.statusText));
        }
        return;
    }
    yield put(connectedToHome(normalizeUrl(url), login, data.token));
}
