import { apply, call, put } from 'redux-saga/effects';

import { normalizeUrl } from "util/util";
import { connectedToHome, connectionToHomeFailed } from "home/actions";
import { messageBox } from "messagebox/actions";
import { openConnectDialog } from "logobar/connectionstatus/connectdialog/actions";

function* connectionToHomeFailedMessage(message, onClose = null) {
    yield put(messageBox("Connection to home failed: " + message, onClose));
}

export function* connectToHome(action) {
    const {location, login, password} = action.payload;
    const url = normalizeUrl(location) + "/moera/api/tokens";
    let response;
    try {
        response = yield call(fetch, url, {
            method: "POST",
            headers: {
                "Accept": "application/json",
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                login,
                password
            })
        });
    } catch (e) {
        yield put(connectionToHomeFailed());
        yield call(connectionToHomeFailedMessage, e.message);
        return;
    }
    const data = yield apply(response, response.json);
    if (!response.ok) {
        if (data && data.errorCode === "credentials.login-incorrect") {
            yield put(connectionToHomeFailed());
            yield call(connectionToHomeFailedMessage, "Login incorrect", openConnectDialog());
        } else {
            yield put(connectionToHomeFailed());
            yield call(connectionToHomeFailedMessage, response.statusText);
        }
        return;
    }
    yield put(connectedToHome(normalizeUrl(location), login, data.token));
}
